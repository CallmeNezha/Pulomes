<!DOCTYPE html>
<html lang="en">
<head>
    <title>xg - zastava fica</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <style>
        body {
            background-color: #000;
            color: #111;
            margin: 0px;
            overflow: hidden;
            font-family: Monospace;
            font-size: 13px;
        }

        #info {
            position: absolute;
            top: 0px; width: 100%;
            left: 0px;
            padding: 5px;
            text-align: center;
            color: #fff;
            display:block;
            text-shadow:1px 1px 6px rgba(0,0,0,0.75);
            background: rgba(0,0,0,0.5);
        }

        .status { font-weight: bold; background: #fa0; color: #fff; padding: 0.25em 1em; position: absolute; top: 0px; right: 0px; z-index: 200 }

        a {
            color: #aaccff;
            text-decoration: none;
        }

        a:hover {
            color: #ffaaaa;
        }

        #footer { width: 100%; margin: 2em auto; text-align: center; position: absolute; bottom: 0 }
        strong { color: red }

        #menu {
            width: 100%;
            margin: 1em auto;
            text-align: left;
            position: absolute;
            bottom: 0;
            display:block;
            padding: 0.5em;
            margin: 0;
        }

        #environments {
            display:none;
        }

        #menubutton {
            color: #666;
            font-weight: bold;
            font-size: 36px;
            cursor: pointer;
            display: inline-block;
            padding: 0.25em;
            vertical-align: middle;
        }

        #menubutton:hover {
            color: #fff;
        }

        #help {
            display: none;
        }

        .thumb {
            width: 57px;
            height: 58px;
            margin: 0.25em;
            cursor: pointer;
            display: inline-block;
            vertical-align: middle;

            box-shadow:2px 2px 5px rgba(0,0,0,0.5);
            -moz-box-shadow:2px 2px 5px rgba(0,0,0,0.5);
            -webkit-box-shadow:2px 2px 5px rgba(0,0,0,0.5);
            -khtml-box-shadow:2px 2px 5px rgba(0,0,0,0.5);
        }

        .thumb:hover {
            box-shadow:2px 2px 5px rgba(0,0,0,0.95);
            -moz-box-shadow:2px 2px 5px rgba(0,0,0,0.95);
            -webkit-box-shadow:2px 2px 5px rgba(0,0,0,0.95);
            -khtml-box-shadow:2px 2px 5px rgba(0,0,0,0.95);
        }

        .thumb img {
            width: 57px;
            height: 58px;
        }

        #stats { position: absolute; top:0; left: 0 }
        #stats #fps { background: transparent !important }
        #stats #fps #fpsText { color: #555 !important }
        #stats #fps #fpsGraph { display: none }
    </style>
</head>
<body>
<div id="loadingWrap">
    <div id="loading" class="status">Loading ...</div>
    <div id="loadingSpec" class="status">Loading ...</div>
    <div id="loadingDiff" class="status">Loading ...</div>
    <div id="loadingBack" class="status">Loading ...</div>
    <div id="loadingBcTn" class="status">Loading ...</div>
</div>

<div id="container"></div>

<div id="info"><a href="http://alteredqualia.com/" target="_blank">xg</a> - IBL rendering -
    Zastava Fica by <a href="http://www.blendswap.com/blends/view/66833" target="_blank">Slobodan Vidovic</a> -
    environment texture by <a href="http://www.hdrlabs.com/sibl/archive.html" id="env_credits" target="_blank">hdrlabs.com</a>
    <span id="help">- click: randomize, arrows: change settings</span></div>

<div id="menu">
    <div id="menubutton">+</div>
    <div id="environments"></div>
</div>

<script src="js/xg.min.fica.js"></script>
<script src="js/libs/stats.min.js"></script>

<script>

    var loadingWrapElement = document.getElementById( 'loadingWrap' );
    var infoElement = document.getElementById( 'info' );
    var menuElement = document.getElementById( 'menu' );
    var helpElement = document.getElementById( 'help' );

    var hasWebGL1 = Detector.webgl;
    var hasWebGL2 = Detector.webgl2;

    if ( ! ( hasWebGL1 || hasWebGL2 ) ) {

        loadingWrapElement.style.display = "none";
        infoElement.style.display = "none";
        menuElement.style.display = "none";

        Detector.addGetWebGLMessage( { fallbackImg: "img/fica.jpg" } );

    } else {

        var useDeferred = true;
        var hudVisible = true;

        var backend = hasWebGL2 ? "webgl2" : "webgl1";

        var isMobile = Detector.isMobile;

        if ( ! Detector.deferredCapable || isMobile ) useDeferred = false;

        if ( ! isMobile ) helpElement.style.display = "inline-block";

        // platform-specific compatibility fixes
        // (mostly things that are supposed to work but are broken anyways)

        var isChrome   = navigator.userAgent.toLowerCase().indexOf( "chrome" ) >= 0;
        var isSafari   = navigator.userAgent.toLowerCase().indexOf( "safari" ) >= 0 && !isChrome;
        var isFirefox  = navigator.userAgent.toLowerCase().indexOf( "firefox" ) >= 0;
        var isExplorer = navigator.userAgent.toLowerCase().indexOf( "trident" ) >= 0;
        var isOSX 	   = navigator.platform.toLowerCase().indexOf( "mac" ) >= 0;

        //

        var isUltra = false;
        var ULTRA_THRESHOLD = 3000;

        //

        var iblHDR = ! isMobile;
        var bgHi = ! isMobile;
        var bakeN = isMobile ? 200 : 1000;

        var SCALE = 1 / window.devicePixelRatio;
        var MARGIN = 80;

        var WIDTH = window.innerWidth;
        var HEIGHT = window.innerHeight - 2 * MARGIN;

        var FOV = MARGIN ? 22.5 : 27.0;

        var toyMode = false;
        var baseBlurScale = 6;
        var toyBlurScale = 4;

        var cameraDistance = 325;
        var cameraFreeze = false;

        var camera, scene, renderer;
        var stats;

        var dayLight;

        var skyMaterial;
        var skyUniforms;
        var skyMesh;

        var overlayMaterial;

        //

        var cache = {};
        var skyCache = {};

        var currentCarCfg;

        //

        //

        var iblConfig = [

            {
                "specularHDR"	: "textures/environments/hdr/summiPoolSpecularHDR.dds",
                "diffuseHDR"	: "textures/environments/hdr/summiPoolDiffuseHDR.dds",
                "specularMDR"	: "textures/environments/hdr/summiPoolSpecularMDR.dds",
                "diffuseMDR"	: "textures/environments/hdr/summiPoolDiffuseMDR.dds",
                "backgroundTn"	: "textures/environments/hdr/summiPoolBackgroundLDR128.jpg",
                "backgroundLo"	: "textures/environments/hdr/summiPoolBackgroundLDR2K.jpg",
                "backgroundHi"	: "textures/environments/hdr/summiPoolBackgroundLDR4K.jpg",
                "thumb"			: "textures/environments/hdr/summiPoolThumb.png",
                "domeSize"		: 300,
                "ambient"		: 1.2,
                "intensity" 	: 1.2,
                "shadow"		: 0.99,
                "position"		: [ 0, 100, -100 ],
                "name"			: "Summi Pool",
                "credits"		: "Blochi"
            },


            {
                "specularHDR"	: "textures/environments/hdr/stadiumCenterSpecularHDR.dds",
                "diffuseHDR"	: "textures/environments/hdr/stadiumCenterDiffuseHDR.dds",
                "specularMDR"	: "textures/environments/hdr/stadiumCenterSpecularMDR.dds",
                "diffuseMDR"	: "textures/environments/hdr/stadiumCenterDiffuseMDR.dds",
                "backgroundTn"	: "textures/environments/hdr/stadiumCenterBackgroundLDR128.jpg",
                "backgroundLo"	: "textures/environments/hdr/stadiumCenterBackgroundLDR2K.jpg",
                "backgroundHi"	: "textures/environments/hdr/stadiumCenterBackgroundLDR4K.jpg",
                "thumb"			: "textures/environments/hdr/stadiumCenterThumb.png",
                "domeSize"		: 500,
                "ambient"		: 1.0,
                "intensity" 	: 1.0,
                "shadow"		: 0.99,
                "position"		: [ 0, 100, 0 ],
                "name"			: "Stadium Center",
                "credits"		: "Blochi"
            },

            {
                "specularHDR"	: "textures/environments/hdr/winterForestSpecularHDR.dds",
                "diffuseHDR"	: "textures/environments/hdr/winterForestDiffuseHDR.dds",
                "specularMDR"	: "textures/environments/hdr/winterForestSpecularMDR.dds",
                "diffuseMDR"	: "textures/environments/hdr/winterForestDiffuseMDR.dds",
                "backgroundTn"	: "textures/environments/hdr/winterForestBackgroundLDR128.jpg",
                "backgroundLo"	: "textures/environments/hdr/winterForestBackgroundLDR2K.jpg",
                "backgroundHi"	: "textures/environments/hdr/winterForestBackgroundLDR4K.jpg",
                "thumb"			: "textures/environments/hdr/winterForestThumb.png",
                "domeSize"		: 300,
                "ambient"		: 1.2,
                "intensity" 	: 0.2,
                "shadow"		: 0.2,
                "position"		: [ 0, 75, 0 ],
                "snow"			: true,
                "name"			: "Winter Forest",
                "credits"		: "Blochi"
            },

            {
                "specularHDR"	: "textures/environments/hdr/monvalleyDirtRoadSpecularHDR.dds",
                "diffuseHDR"	: "textures/environments/hdr/monvalleyDirtRoadDiffuseHDR.dds",
                "specularMDR"	: "textures/environments/hdr/monvalleyDirtRoadSpecularMDR.dds",
                "diffuseMDR"	: "textures/environments/hdr/monvalleyDirtRoadDiffuseMDR.dds",
                "backgroundTn"	: "textures/environments/hdr/monvalleyDirtRoadBackgroundLDR128.jpg",
                "backgroundLo"	: "textures/environments/hdr/monvalleyDirtRoadBackgroundLDR2K.jpg",
                "backgroundHi"	: "textures/environments/hdr/monvalleyDirtRoadBackgroundLDR4K.jpg",
                "thumb"			: "textures/environments/hdr/monvalleyDirtRoadThumb.png",
                "domeSize"		: 300,
                "ambient"		: 1.0,
                "intensity" 	: 1.2,
                "shadow"		: 0.99,
                "position"		: [ -100, 30, -5 ],
                "haze"			: true,
                "name"			: "MonValley Dirtroad",
                "credits"		: "Blochi"
            },

            {
                "specularHDR"	: "textures/environments/hdr/desertHighwaySpecularHDR.dds",
                "diffuseHDR"	: "textures/environments/hdr/desertHighwayDiffuseHDR.dds",
                "specularMDR"	: "textures/environments/hdr/desertHighwaySpecularMDR.dds",
                "diffuseMDR"	: "textures/environments/hdr/desertHighwayDiffuseMDR.dds",
                "backgroundTn"	: "textures/environments/hdr/desertHighwayBackgroundLDR128.jpg",
                "backgroundLo"	: "textures/environments/hdr/desertHighwayBackgroundLDR2K.jpg",
                "backgroundHi"	: "textures/environments/hdr/desertHighwayBackgroundLDR4K.jpg",
                "thumb"			: "textures/environments/hdr/desertHighwayThumb.png",
                "domeSize"		: 300,
                "ambient"		: 1.2,
                "intensity" 	: 1.2,
                "shadow"		: 0.8,
                "position"		: [ 0, 75, 100 ],
                "haze"			: true,
                "name"			: "Desert Highway",
                "credits"		: "Blochi"
            },

            {
                "specularHDR"	: "textures/environments/hdr/charlestonSunsetSpecularHDR.dds",
                "diffuseHDR"	: "textures/environments/hdr/charlestonSunsetDiffuseHDR.dds",
                "specularMDR"	: "textures/environments/hdr/charlestonSunsetSpecularMDR.dds",
                "diffuseMDR"	: "textures/environments/hdr/charlestonSunsetDiffuseMDR.dds",
                "backgroundTn"	: "textures/environments/hdr/charlestonSunsetBackgroundLDR128.jpg",
                "backgroundLo"	: "textures/environments/hdr/charlestonSunsetBackgroundLDR2K.jpg",
                "backgroundHi"	: "textures/environments/hdr/charlestonSunsetBackgroundLDR4K.jpg",
                "thumb"			: "textures/environments/hdr/charlestonSunsetThumb.png",
                "domeSize"		: 300,
                "ambient"		: 1.2,
                "intensity" 	: 0.2,
                "shadow"		: 0.2,
                "position"		: [ 100, 30, 50 ],
                "name"			: "Charleston Sunset",
                "credits"		: "HDR-VFX"
            },

            {
                "specularHDR"	: "textures/environments/hdr/subwayLightsSpecularHDR.dds",
                "diffuseHDR"	: "textures/environments/hdr/subwayLightsDiffuseHDR.dds",
                "specularMDR"	: "textures/environments/hdr/subwayLightsSpecularMDR.dds",
                "diffuseMDR"	: "textures/environments/hdr/subwayLightsDiffuseMDR.dds",
                "backgroundTn"	: "textures/environments/hdr/subwayLightsBackgroundLDR128.jpg",
                "backgroundLo"	: "textures/environments/hdr/subwayLightsBackgroundLDR2K.jpg",
                "backgroundHi"	: "textures/environments/hdr/subwayLightsBackgroundLDR4K.jpg",
                "thumb"			: "textures/environments/hdr/subwayLightsThumb.png",
                "domeSize"		: 300,
                "ambient"		: 1.2,
                "intensity" 	: 0.2,
                "shadow"		: 0.2,
                "position"		: [ 0, 75, 0 ],
                "name"			: "Subway Lights",
                "credits"		: "Blochi"
            },


            {
                "specularHDR"	: "textures/environments/hdr/theatreCenterSpecularHDR.dds",
                "diffuseHDR"	: "textures/environments/hdr/theatreCenterDiffuseHDR.dds",
                "specularMDR"	: "textures/environments/hdr/theatreCenterSpecularMDR.dds",
                "diffuseMDR"	: "textures/environments/hdr/theatreCenterDiffuseMDR.dds",
                "backgroundTn"	: "textures/environments/hdr/theatreCenterBackgroundLDR128.jpg",
                "backgroundLo"	: "textures/environments/hdr/theatreCenterBackgroundLDR2K.jpg",
                "backgroundHi"	: "textures/environments/hdr/theatreCenterBackgroundLDR4K.jpg",
                "thumb"			: "textures/environments/hdr/theatreCenterThumb.png",
                "domeSize"		: 300,
                "ambient"		: 2.0,
                "intensity" 	: 0.5,
                "shadow"		: 0.8,
                "position"		: [ 0, 75, 0 ],
                "name"			: "Theatre Center",
                "credits"		: "Blochi"
            },

        ];

        var iblIndex = 0;

        var elEnvCredits = document.getElementById( "env_credits" );

        //

        var matLib = {

            "glossy-red":
            {
                "diffuse"	: [ 0.0, 0.9, 0.7 ],
                "specular"	: [ 0.0, 0.0, 0.125 ],
                "shininess"	: 8192,
                "wrap"		: 0.5
            },

            "glossy-orange1":
            {
                "diffuse"	: [ 0.05, 0.95, 0.95 ],
                "specular"	: [ 0.0, 0.0, 0.125 ],
                "shininess"	: 8192,
                "wrap"		: 0.5
            },

            "glossy-orange2":
            {
                "diffuse"	: [ 0.08, 0.9, 0.9 ],
                "specular"	: [ 0.0, 0.0, 0.125 ],
                "shininess"	: 8192,
                "wrap"		: 0.5
            },

            "glossy-green1":
            {
                "diffuse"	: [ 0.2, 0.8, 0.7 ],
                "specular"	: [ 0.0, 0.0, 0.125 ],
                "shininess"	: 8192,
                "wrap"		: 0.5
            },

            "glossy-green2":
            {
                "diffuse"	: [ 0.3, 0.8, 0.5 ],
                "specular"	: [ 0.0, 0.0, 0.125 ],
                "shininess"	: 8192,
                "wrap"		: 0.5
            },

            "glossy-green3":
            {
                "diffuse"	: [ 0.3, 0.75, 0.25 ],
                "specular"	: [ 0.0, 0.0, 0.125 ],
                "shininess"	: 8192,
                "wrap"		: 0.5
            },

            "glossy-blue":
            {
                "diffuse"	: [ 0.55, 0.8, 0.7 ],
                "specular"	: [ 0.0, 0.0, 0.125 ],
                "shininess"	: 8192,
                "wrap"		: 0.5
            },

            "glossy-white":
            {
                "diffuse"	: [ 0.0, 0.0, 0.85 ],
                "specular"	: [ 0.0, 0.0, 0.15 ],
                "shininess"	: 8192,
                "wrap"		: 0.5
            },

            "glossy-black":
            {
                "diffuse"	: [ 0.0, 0.0, 0.0 ],
                "specular"	: [ 0.0, 0.0, 0.1 ],
                "shininess"	: 8192
            },

            "glossy-gray":
            {
                "diffuse"	: [ 0.0, 0.0, 0.1 ],
                "specular"	: [ 0.0, 0.0, 0.15 ],
                "shininess"	: 8192
            },

            "silver-1":
            {
                "diffuse"	: [ 0.58, 0.9, 0.05 ],
                "specular"	: [ 0.0, 0.0, 0.8 ],
                "shininess"	: 2048
            },

            "silver-2":
            {
                "diffuse"	: [ 0.58, 0.09, 0.85 ],
                "specular"	: [ 0.0, 0.0, 0.8 ],
                "shininess"	: 2048
            },

            "silver-3":
            {
                "diffuse"	: [ 0.58, 0.9, 0.05 ],
                "specular"	: [ 0.0, 0.0, 0.8 ],
                "shininess"	: 4096
            },

            "chrome-light":
            {
                "diffuse"	: [ 0.58, 0.9, 0.05 ],
                "specular"	: [ 0.0, 0.0, 0.9 ],
                "shininess"	: 8192
            },

            "chrome-dark":
            {
                "diffuse"	: [ 0.0, 0.0, 0.0 ],
                "specular"	: [ 0.0, 0.0, 0.9 ],
                "shininess"	: 8192
            },

            "matte-black":
            {
                "diffuse"	: [ 0.0, 0.0, 0.2 ],
                "specular"	: [ 0.0, 0.0, 0.15 ],
                "shininess"	: 30
            }

        }

        var matConfig = [

            {
                "chassis":
                {
                    5: "glossy-red", // body

                },

                "wheels":
                {
                    0: "chrome-dark", 	// disc
                    1: "matte-black"	// tires
                }

            },

            {
                "chassis":
                {
                    5: "glossy-orange1", // body

                },

                "wheels":
                {
                    0: "chrome-dark", 	// disc
                    1: "matte-black"	// tires
                }

            },

            {
                "chassis":
                {
                    5: "glossy-orange2", // body

                },

                "wheels":
                {
                    0: "chrome-dark", 	// disc
                    1: "matte-black"	// tires
                }

            },

            {
                "chassis":
                {
                    5: "glossy-green1", // body

                },

                "wheels":
                {
                    0: "chrome-dark", 	// disc
                    1: "matte-black"	// tires
                }

            },

            {
                "chassis":
                {
                    5: "glossy-green2", // body

                },

                "wheels":
                {
                    0: "chrome-dark", 	// disc
                    1: "matte-black"	// tires
                }

            },

            {
                "chassis":
                {
                    5: "glossy-green3", // body

                },

                "wheels":
                {
                    0: "chrome-dark", 	// disc
                    1: "matte-black"	// tires
                }

            },

            {
                "chassis":
                {
                    5: "glossy-blue", // body

                },

                "wheels":
                {
                    0: "chrome-dark", 	// disc
                    1: "matte-black"	// tires
                }

            },

            {
                "chassis":
                {
                    5: "glossy-white", // body

                },

                "wheels":
                {
                    0: "chrome-dark", 	// disc
                    1: "matte-black"	// tires
                }

            },

            {
                "chassis":
                {
                    5: "glossy-black", // body

                },

                "wheels":
                {
                    0: "chrome-dark", 	// disc
                    1: "matte-black"	// tires
                }

            },

            {
                "chassis":
                {
                    5: "silver-1", // body

                },

                "wheels":
                {
                    0: "chrome-dark", 	// disc
                    1: "matte-black"	// tires
                }

            },

            {
                "chassis":
                {
                    5: "silver-2", // body

                },

                "wheels":
                {
                    0: "chrome-dark", 	// disc
                    1: "matte-black"	// tires
                }

            },

        ];

        var matIndex = 0;

        // particles

        var particleMaterials = [];
        var particles = [];

        //

        var cx, cy, tx, ty;

        //

        var baker;

        //

        var heatUniforms;
        var effectHeat;

        //

        var loaded = false;
        var loadCounter = 0;

        var loadingElement = document.getElementById( 'loading' );
        var loadingElementSpec = document.getElementById( 'loadingSpec' );
        var loadingElementDiff = document.getElementById( 'loadingDiff' );
        var loadingElementBack = document.getElementById( 'loadingBack' );
        var loadingElementBcTn = document.getElementById( 'loadingBcTn' );

        // menu

        var menuVisible = false;

        // controls

        var mouseX = 0;
        var mouseY = 0;

        var targetX = 0.0, targetY = 0.0;
        var angle = 0.0;
        var height = 0.0;
        var target = new XG.Vector3();

        var windowHalfX = window.innerWidth / 2;
        var windowHalfY = window.innerHeight / 2;

        var clock = new XG.Clock();

        function init() {

            XG.ImageUtils.halfFloatType = ( backend === "webgl1" ) ? XG.HalfFloatType1 : XG.HalfFloatType2;

            initMenu();

            var container = document.getElementById( 'container' );

            camera = new XG.PerspectiveCamera( FOV, WIDTH / HEIGHT, 1, 2000 );
            camera.position.set( -150, 80, 350 );
            camera.lookAt( new XG.Vector3( 0, 0, 0 ) );

            scene = new XG.Scene();
            scene.add( camera );

            //

            if ( isMobile ) {

                var overlayMap = new XG.ImageUtils.loadTexture( "textures/vignette.png", checkStatus );

                overlayMaterial = new XG.EmissiveMaterial();
                overlayMaterial.color.setHSV( 0, 0, 1 );
                overlayMaterial.map = overlayMap;
                overlayMaterial.transparent = true;
                overlayMaterial.opacity = 0.4;

            }

            // LIGHTS

            dayLight = new XG.DayLightCube();

            dayLight.color.setHSV( 0.1, 0.1, 1 );
            dayLight.position.set( -0.5, 0.75, 0.5 );
            dayLight.position.multiplyScalar( 150 );


            dayLight.intensity = 1;
            dayLight.ambientIntensity = 0.65;

            scene.add( dayLight );

            dayLight.castShadow = true;

            var mm = 1;

            dayLight.shadowMapWidth  = 1024 * mm;
            dayLight.shadowMapHeight = 1024 * mm;

            var d = 350;

            dayLight.shadowCameraLeft = -d;
            dayLight.shadowCameraRight = d;
            dayLight.shadowCameraTop = d;
            dayLight.shadowCameraBottom = -d;

            dayLight.shadowCameraNear = 1;
            dayLight.shadowCameraFar = 4500;
            dayLight.shadowDarkness = 0.95;

            if ( ! Detector.supportsShaderTextureLod( backend ) ) {

                var mipCubeUrl = "textures/environments/MipCube128.dds";

                var cubemapMip = XG.ImageUtils.loadCompressedTextureCube( mipCubeUrl );
                dayLight.textureMip = cubemapMip;

            }

            // SKYDOME

            skyMaterial = XG.IBLUtils.createDomeMaterial();
            skyMaterial.occluder = true;
            skyUniforms = skyMaterial.uniforms;

            var d = -50;
            var domeSize = 500;
            var skyGeo = XG.IBLUtils.createDomeGeometry( domeSize, 32, 16, d );

            skyMesh = new XG.Mesh( skyGeo, skyMaterial );
            skyMesh.position.y = 35;
            skyMesh.rotation.y = Math.PI;
            skyMesh.receiveShadow = true;
            skyMesh.renderDepth = 10;
            scene.add( skyMesh );

            skyCache[ domeSize ] = skyMesh;

            // SHADOW PLANE

            var groundMaterial = XG.IBLUtils.createGroundMaterial();
            groundMaterial.uniforms.intensity.value = 3;
            groundMaterial.occluder = true;
            groundMaterial.depthWrite = false;

            var groundGeo = new XG.PlaneGeometry( 300, 300 );
            ground = new XG.Mesh( groundGeo, groundMaterial );
            ground.position.setY( -14.9 );
            ground.rotation.x = Math.PI * -0.5;
            ground.receiveShadow = true;
            ground.renderDepth = 5;
            scene.add( ground );

            // PARTICLES

            addParticles( scene );

            // MODEL

            var loader = new XG.UTF8Loader();

            if ( 1 ) {

                currentCarCfg = {};

                var chassisUrl = isMobile ? "models/utf8/fica/fica_ao_lod1.js" : "models/utf8/fica/fica_ao_lod0.js";
                var wheelUrl = isMobile ? "models/utf8/fica/fica_ao_wheel_lod1.js" : "models/utf8/fica/fica_ao_wheel_lod0.js";

                var detailMap = XG.ImageUtils.loadTexture( "textures/noise.jpg", checkStatus );
                detailMap.anisotropy = 16;
                detailMap.wrapS = detailMap.wrapT = XG.RepeatWrapping;

                var dummyWhite = XG.ImageUtils.generateDataTexture( 4, 4, new XG.Color( 0x000000 ) );

                var root = new XG.Node();
                scene.add( root );

                root.rotation.y = Math.PI * -0.35;

                var chassis;
                var wheel0, wheel1, wheel2, wheel3;

                function startBakeFica() {

                    baker = new XG.LightmapBaker( renderer, { "lightMapType": XG.FloatType, "samplingType": 2, "shadowMapType": XG.PCFSoftHQShadowMap, "shadowCameraWidth": 85, "shadowMapSize": 256 } );
                    baker.useSeamsFix();

                    var lightMapSize = 128;

                    var chassisMatId = isMobile ? 6 : 2;
                    baker.addObject( chassis, chassisMatId, lightMapSize );

                    var wheelMatId = 0;
                    baker.addObject( wheel0, wheelMatId, lightMapSize );
                    baker.addObject( wheel1, wheelMatId, lightMapSize );
                    baker.addObject( wheel2, wheelMatId, lightMapSize );
                    baker.addObject( wheel3, wheelMatId, lightMapSize );

                    baker.addObject( ground, 0, lightMapSize * 2 );

                    baker.setScale( 0.3 );

                }

                loader.load( chassisUrl, function ( geometries, materials ) {

                    if ( isMobile ) {

                        for ( var i = 0, il = geometries.length; i < il; i ++ ) {

                            var g = geometries[ i ];
                            g.computeVertexNormals();

                        }

                    }

                    XG.GeometryUtils.center( geometries );

                    var body = materials[5];
                    //body.color.setHSV( 0.05, 0.95, 0.95 );
                    body.color.setHSV( 0.0, 0.9, 0.7 );
                    body.specular.setHSV( 0, 0, 0.15 );

                    body.bumpMap = dummyWhite;
                    body.bumpDetailMap = detailMap;

                    body.detailScale = 0.05;
                    body.detailRepeat.multiplyScalar( 8 );

                    body.wrapAround = true;
                    body.wrapRGB.set( body.color.r, body.color.g, body.color.b ).multiplyScalar( 0.5 );

                    chassis = new XG.Mesh( geometries, materials );
                    chassis.scale.multiplyScalar( 21 );
                    chassis.position.y = 17;

                    chassis.castShadow = true;
                    chassis.receiveShadow = true;

                    root.add( chassis );

                    currentCarCfg.chassis = [ chassis ];
                    currentCarCfg.chassisMaterials = materials;

                    if ( chassis && wheel0 && !baker ) {

                        startBakeFica();

                    }

                    checkStatus();

                } );


                loader.load( wheelUrl, function ( geometries, materials ) {

                    for ( var i = 0, il = geometries.length; i < il; i ++ ) {

                        var g = geometries[ i ];
                        g.computeVertexNormals();

                    }

                    XG.GeometryUtils.center( geometries );

                    var dy = -19;
                    var dx = 24.75;
                    var dz = 46.5;
                    var dz2 = 38.0;

                    var dry = 0.3;

                    wheel0 = new XG.Mesh( geometries, materials );
                    wheel0.scale.multiplyScalar( 21 );
                    wheel0.position.y = 15 + dy;
                    wheel0.position.x = dx;
                    wheel0.position.z = dz;

                    wheel0.rotation.y = dry;

                    wheel0.castShadow = true;
                    wheel0.receiveShadow = true;

                    root.add( wheel0 );

                    wheel1 = new XG.Mesh( geometries, materials );
                    wheel1.scale.multiplyScalar( 21 );
                    wheel1.position.y = 15 + dy;
                    wheel1.position.x = -dx;
                    wheel1.position.z = dz;

                    wheel1.rotation.y = Math.PI + dry;

                    wheel1.castShadow = true;
                    wheel1.receiveShadow = true;

                    root.add( wheel1 );

                    //

                    wheel2 = new XG.Mesh( geometries, materials );
                    wheel2.scale.multiplyScalar( 21 );
                    wheel2.position.y = 15 + dy;
                    wheel2.position.x = dx;
                    wheel2.position.z = -dz2;

                    wheel2.castShadow = true;
                    wheel2.receiveShadow = true;

                    root.add( wheel2 );

                    wheel3 = new XG.Mesh( geometries, materials );
                    wheel3.scale.multiplyScalar( 21 );
                    wheel3.position.y = 15 + dy;
                    wheel3.position.x = -dx;
                    wheel3.position.z = -dz2;

                    wheel3.rotation.y = Math.PI;

                    wheel3.castShadow = true;
                    wheel3.receiveShadow = true;

                    root.add( wheel3 );

                    currentCarCfg.wheels = [ wheel0, wheel1, wheel2, wheel3 ];
                    currentCarCfg.wheelMaterials = materials;

                    if ( chassis && wheel0 && !baker ) {

                        startBakeFica();

                    }

                    checkStatus();

                } );

                loader.load( "models/utf8/fica/fica_ao_glass_front.js", function ( geometries, materials ) {

                    materials[0].occluder = true;
                    materials[0].forceShadow = true;

                    XG.GeometryUtils.center( geometries );

                    var dy = 12.8;
                    var dx = 24.75;
                    var dz = -8.5;

                    dz = 28;
                    dy = 13.8;

                    glass = new XG.Mesh( geometries, materials );
                    glass.scale.multiplyScalar( 21 );
                    glass.position.y = 15 + dy;
                    glass.position.z = dz;

                    glass.castShadow = true;
                    glass.receiveShadow = true;

                    root.add( glass );

                    checkStatus();

                } );

                loader.load( "models/utf8/fica/fica_ao_glass_back.js", function ( geometries, materials ) {

                    materials[0].occluder = true;

                    XG.GeometryUtils.center( geometries );

                    var dy = 12.8;
                    var dx = 24.75;
                    var dz = -8.5;

                    dz = -45.5;
                    dy = 14.5;

                    glass = new XG.Mesh( geometries, materials );
                    glass.scale.multiplyScalar( 21 );
                    glass.position.y = 15 + dy;
                    glass.position.z = dz;

                    glass.castShadow = true;
                    glass.receiveShadow = true;

                    root.add( glass );

                    checkStatus();

                } );

                loader.load( "models/utf8/fica/fica_ao_glass_left.js", function ( geometries, materials ) {

                    materials[0].occluder = true;

                    XG.GeometryUtils.center( geometries );

                    var dy = 12.8;
                    var dx = 24.75;
                    var dz = -8.5;

                    dz = -8.5;
                    dy = 12.25;
                    dx = 23;

                    glass = new XG.Mesh( geometries, materials );
                    glass.scale.multiplyScalar( 21 );
                    glass.position.y = 15 + dy;
                    glass.position.z = dz;
                    glass.position.x = dx;

                    glass.castShadow = true;
                    glass.receiveShadow = true;

                    root.add( glass );

                    checkStatus();

                } );

                loader.load( "models/utf8/fica/fica_ao_glass_right.js", function ( geometries, materials ) {

                    materials[0].occluder = true;

                    XG.GeometryUtils.center( geometries );

                    var dy = 12.8;
                    var dx = 24.75;
                    var dz = -8.5;

                    dz = -8.5;
                    dy = 12.25;
                    dx = -23;

                    glass = new XG.Mesh( geometries, materials );
                    glass.scale.multiplyScalar( 21 );
                    glass.position.y = 15 + dy;
                    glass.position.z = dz;
                    glass.position.x = dx;

                    glass.castShadow = true;
                    glass.receiveShadow = true;

                    root.add( glass );

                    checkStatus();

                } );

            }

            // RENDERER

            var pars = {

                width: WIDTH,
                height: HEIGHT,
                scale: SCALE,
                tonemapping: XG.Filmic2015Operator,
                brightness: 1,
                useMultipleRenderTargets: true,
                backend: backend

            };

            if ( useDeferred ) {

                pars.temporalAA = true;
                pars.antialias = false;

                renderer = new XG.DeferredRenderer( pars );

            } else {

                pars.devicePixelRatio = 1.0;
                pars.antialias = true;

                renderer = new XG.ForwardRenderer( pars );

            }

            container.appendChild( renderer.domElement );

            renderer.domElement.style.position = "absolute";
            renderer.domElement.style.top = MARGIN + "px";
            renderer.domElement.style.left = "0px";


            renderer.shadowMapEnabled = true;
            renderer.shadowMapType = XG.PCFSoftHQShadowMap;
            renderer.shadowMapCullFace = XG.CullFaceNone;

            renderer.shadowMapSlopeDepthBias = true;

            if ( ! isOSX ) renderer.shadowMapUseDepthTextures = true;

            if ( useDeferred ) {

                renderer.occludersEnabled = true;

                renderer.dofEnabled = true;
                renderer.dofFancy = true;
                renderer.dofAutofocus = true;

                renderer.dofFocusDistance = 80;

                renderer.dofLensFstop = 2;
                renderer.dofLensBlurScale = baseBlurScale;

                renderer.dofFocusWidth = 40;
                renderer.dofFocusRampWidth = 80;

                var fovRad = XG.Math.degToRad( camera.fov );
                renderer.dofLensFocalLength = XG.Math.fovToFocalLength( fovRad, 24 );

                //

                groundMaterial.defines[ "DEFERRED" ] = true;

                //

                var noiseMap = XG.ImageUtils.loadTexture( "textures/rgbNoise.png", checkStatus );
                noiseMap.wrapS = noiseMap.wrapT = XG.RepeatWrapping;

                effectHeat = new XG.ShaderPass( XG.HeatHazeShader );
                effectHeat.uniforms.tNoise.value = noiseMap;
                effectHeat.uniforms.distortionScale.value = 2.00;
                effectHeat.uniforms.distortionFactor.value = 0.005;
                effectHeat.uniforms.riseFactor.value = 0.1;
                effectHeat.uniforms.startDistance.value = 325.0;

                heatUniforms = effectHeat.uniforms;

                renderer.addEffect( effectHeat, { "depthUniform": "tDepth" } );

            }

            cx = camera.position.x;
            cy = camera.position.y;

            tx = target.x;
            ty = target.y;

            // STATS

            stats = new Stats();
            container.appendChild( stats.domElement );

            //

            window.addEventListener( 'resize', onWindowResize, false );
            document.addEventListener( 'mousemove', onDocumentMouseMove, false );
            document.addEventListener( 'keydown', onKeyDown, false );

            renderer.domElement.addEventListener( 'click', onDocumentClick, true );
            renderer.domElement.addEventListener( 'touchmove', onTouchMove, false );

            // INIT

            iblIndex = 0;
            setIBL( iblIndex );

            // init

            var gpuDetector = new GPUDetector();
            gpuData = gpuDetector.detectGPU();

            if ( gpuData && gpuData.rawScore >= ULTRA_THRESHOLD ) toggleUltra();

        }

        // --------------------------------------------------------------------

        function onWindowResize() {

            WIDTH = window.innerWidth;
            HEIGHT = window.innerHeight - 2 * MARGIN;

            renderer.domElement.style.top = MARGIN + "px";

            renderer.setSize( WIDTH, HEIGHT );

            camera.fov = FOV;
            camera.aspect = WIDTH / HEIGHT;
            camera.updateProjectionMatrix();

        }

        function onDocumentMouseMove( event ) {

            mouseX = ( event.clientX - windowHalfX ) * 1;
            mouseY = ( event.clientY - windowHalfY ) * 1;

        }

        function onTouchMove( event ) {

            event.preventDefault();

            var touches = event.touches;
            var touch = touches[ 0 ];

            mouseX = ( touch.clientX - windowHalfX ) * 1;
            mouseY = ( touch.clientY - windowHalfY ) * 1;

        }

        function onDocumentClick( event ) {

            randomizeSettings();

        }

        function onKeyDown ( event ) {

            switch ( event.keyCode ) {

                case 38: /*up*/
                case 87: /*W*/ 	matIndex = ( matIndex + 1 ) % matConfig.length; setMaterials( matIndex, currentCarCfg ); break;

                case 40: /*down*/
                case 83: /*S*/ 	matIndex = ( matIndex - 1 ) % matConfig.length; if ( matIndex < 0 ) matIndex += matConfig.length; setMaterials( matIndex, currentCarCfg ); break;

                case 37: /*left*/
                case 65: /*A*/   iblIndex = ( iblIndex - 1 ) % iblConfig.length; if ( iblIndex < 0 ) iblIndex += iblConfig.length; setIBL( iblIndex ); break;

                case 39: /*right*/
                case 68: /*D*/    iblIndex = ( iblIndex + 1 ) % iblConfig.length; setIBL( iblIndex ); break;

                case 32: /*space*/ randomizeSettings(); break;

                case 80: /*P*/	toggleDOF(); break;
                case 84: /*T*/	toggleCamera(); break;
                case 72: /*H*/	toggleHUD(); break;
                case 77: /*M*/	toggleMargins(); break;
                case 70: /*F*/	toggleFreeze(); break;

                case 85: /*U*/	if ( !event.ctrlKey ) toggleUltra(); break;

            }

        }

        // --------------------------------------------------------------------

        function toggleFreeze() {

            cameraFreeze = ! cameraFreeze;

        }

        function toggleMargins() {

            if ( MARGIN === 0 ) {

                MARGIN = 80;

            } else {

                MARGIN = 0;

            }

            if ( toyMode ) {

                FOV = MARGIN ? 38.0 : 45.0;

            } else {

                FOV = MARGIN ? 22.5 : 27.0;

            }

            onWindowResize();

        }

        function toggleHUD() {

            if ( hudVisible ) {

                stats.domElement.style.display = "none";
                infoElement.style.display = "none";
                menuElement.style.display = "none";

                hudVisible = false;

            } else {

                stats.domElement.style.display = "block";
                infoElement.style.display = "block";
                menuElement.style.display = "block";

                hudVisible = true;

            }

        }

        function toggleDOF() {

            if ( useDeferred ) renderer.setDOF( ! renderer.dofEnabled );

        }

        function toggleCamera() {

            if ( toyMode ) {

                FOV = MARGIN ? 22.5 : 27.0;
                renderer.dofLensBlurScale = isUltra ? baseBlurScale / 1.5 : baseBlurScale;
                cameraDistance = 325;

            } else {

                FOV = MARGIN ? 38.0 : 45.0;
                renderer.dofLensBlurScale = isUltra ? toyBlurScale / 1.5 : toyBlurScale;
                cameraDistance = 300;

            }

            toyMode = ! toyMode;

            camera.fov = FOV;
            camera.aspect = WIDTH / HEIGHT;
            camera.updateProjectionMatrix();

            var fovRad = XG.Math.degToRad( camera.fov );
            renderer.dofLensFocalLength = XG.Math.fovToFocalLength( fovRad, 24 );

        }

        function toggleUltra() {

            if ( ! useDeferred ) return;

            if ( !isUltra ) {

                renderer.setScale( 1.5 );
                renderer.dofLensBlurScale = toyMode ? toyBlurScale / 1.5 : baseBlurScale / 1.5;
                isUltra = true;

            } else {

                renderer.setScale( SCALE );
                renderer.dofLensBlurScale = toyMode ? toyBlurScale : baseBlurScale;
                isUltra = false;

            }

        }

        // --------------------------------------------------------------------

        function randomizeSettings() {

            var testIblIndex;

            do {

                testIblIndex = XG.Math.randomInt( 0, iblConfig.length - 1 );

            } while ( testIblIndex === iblIndex );

            iblIndex = testIblIndex;
            setIBL( iblIndex );

            //

            var testMatIndex;

            do {

                testMatIndex = XG.Math.randomInt( 0, matConfig.length - 1 );

            } while ( testMatIndex === matIndex );

            matIndex = testMatIndex;

            setMaterials( matIndex, currentCarCfg );

        }

        // --------------------------------------------------------------------

        function setMaterials( index, carCfg ) {

            var pars = matConfig[ index ];

            var chassisMeshes = carCfg.chassis;
            var wheelMeshes = carCfg.wheels;

            var chassisMaterials = carCfg.chassisMaterials;
            var wheelMaterials = carCfg.wheelMaterials;

            var bodyColor;

            for ( var i in pars.chassis ) {

                var matId = pars.chassis[ i ];
                var matVal = matLib[ matId ];
                var mat = chassisMaterials[ i ];

                var diffuse = matVal.diffuse;
                var specular = matVal.specular;

                var hd = diffuse[0];
                var sd = diffuse[1];
                var vd = diffuse[2];

                var hs = specular[0];
                var ss = specular[1];
                var vs = specular[2];

                mat.color.setHSV( hd, sd, vd );
                mat.specular.setHSV( hs, ss, vs );
                mat.shininess = matVal.shininess;

                if ( pars.wrap ) {

                    mat.wrapRGB.set( mat.color.r, mat.color.g, mat.color.b ).multiplyScalar( pars.wrap );

                }

                bodyColor = mat.color;

            }

            for ( var i in pars.wheels ) {

                var matId = pars.wheels[ i ];
                var matVal = matLib[ matId ];
                var mat = wheelMaterials[ i ];

                var diffuse = matVal.diffuse;
                var specular = matVal.specular;

                mat.color.setHSV( diffuse[ 0 ], diffuse[ 1 ], diffuse[ 2 ] );
                mat.specular.setHSV( specular[ 0 ], specular[ 1 ], specular[ 2 ] );
                mat.shininess = matVal.shininess;

                if ( pars.wrap ) {

                    mat.wrapRGB.set( mat.color.r, mat.color.g, mat.color.b ).multiplyScalar( pars.wrap );

                }

            }

            for ( var i = 0, il = chassisMeshes.length; i < il; i ++ ) {

                var chassisMesh = chassisMeshes[ i ];
                chassisMesh.properties.deferredNeedsUpdate = true;

            }

            for ( var i = 0, il = wheelMeshes.length; i < il; i ++ ) {

                var wheelMesh = wheelMeshes[ i ];
                wheelMesh.properties.deferredNeedsUpdate = true;

            }

            skyUniforms.bounceColor.value.copy( bodyColor );
            skyUniforms.bounceStrength.value = 0.15;

        }

        // --------------------------------------------------------------------

        function setIBL( index ) {

            var pars = iblConfig[ index ];

            var bgLabel = bgHi ? "backgroundHi" : "backgroundLo";
            var specularLabel = iblHDR ? "specularHDR" : "specularMDR";
            var diffuseLabel = iblHDR ? "diffuseHDR" : "diffuseMDR";

            var specularURL = pars[ specularLabel ];
            var diffuseURL = pars[ diffuseLabel ];
            var bgURL = pars[ bgLabel ];
            var bgTnURL = pars.backgroundTn;

            // TEXTURES

            var supportsHalfFloats = Detector.supportsHalfFloatTextures( backend );
            var supportsFloats = Detector.supportsFloatTextures( backend );

            if ( cache[ specularURL ] === undefined ) {

                loadingElementSpec.style.display = "block";

                var texture = XG.ImageUtils.loadCompressedTextureCube( specularURL, function ( tex ) {

                    if ( tex.type === XG.ImageUtils.halfFloatType && ! supportsHalfFloats && supportsFloats ) {

                        console.log( "Missing half-float textures support, converting to float textures" );

                        XG.ImageUtils.convertHalfFloatToFloatTexture( tex );
                        dayLight.textureEncoding = XG.rgba32fEncoding;
                        dayLight.textureGamma = false;

                    }

                    loadingElementSpec.style.display = "none";

                } );

                texture.anisotropy = 16;
                cache[ specularURL ] = texture;

            }

            if ( cache[ diffuseURL ] === undefined ) {

                loadingElementDiff.style.display = "block";

                var texture = XG.ImageUtils.loadCompressedTextureCube( diffuseURL, function ( tex ) {

                    if ( tex.type === XG.ImageUtils.halfFloatType && ! supportsHalfFloats && supportsFloats ) {

                        console.log( "Missing half-float textures support, converting to float textures" );

                        XG.ImageUtils.convertHalfFloatToFloatTexture( tex );
                        dayLight.textureEncoding = XG.rgba32fEncoding;
                        dayLight.textureGamma = false;

                    }

                    loadingElementDiff.style.display = "none";

                } );

                texture.minFilter = texture.magFilter = XG.LinearFilter;

                cache[ diffuseURL ] = texture;

            }

            // --------------------------------------------------------------------

            if ( cache[ bgTnURL ] === undefined ) {

                loadingElementBcTn.style.display = "block";

                var texture = XG.ImageUtils.loadTexture( bgTnURL, function() { loadingElementBcTn.style.display = "none"; } );
                texture.anisotropy = 16;

                cache[ bgTnURL ] = texture;

            }

            if ( cache[ bgURL ] === undefined ) {

                loadingElementBack.style.display = "block";

                var texture = XG.ImageUtils.loadTexture( bgURL, function() {

                    texture.loaded = true;

                    if ( iblIndex === index ) {

                        skyUniforms.map.value = texture;

                    }
                    loadingElementBack.style.display = "none";

                } );

                texture.anisotropy = 16;
                texture.loaded = false;

                cache[ bgURL ] = texture;

            }

            // --------------------------------------------------------------------

            var cubemapSpecular = cache[ specularURL ];
            var cubemapDiffuse  = cache[ diffuseURL ];
            var background      = cache[ bgURL ].loaded ? cache[ bgURL ] : cache[ bgTnURL ];

            // LIGHT

            var px = pars.position[ 0 ];
            var py = pars.position[ 1 ];
            var pz = pars.position[ 2 ];

            dayLight.position.set( px, py, pz );
            dayLight.intensity = pars.intensity;
            dayLight.ambientIntensity = pars.ambient;
            dayLight.shadowDarkness = pars.shadow;

            dayLight.textureSpecular = cubemapSpecular;
            dayLight.textureDiffuse = cubemapDiffuse;
            dayLight.textureFixSeams = false;

            if ( iblHDR ) {

                dayLight.textureEncoding = XG.rgba16fEncoding;
                dayLight.textureGamma = false;

            } else {

                dayLight.textureEncoding = XG.rgbm8Encoding;
                dayLight.textureGamma = true;

            }

            dayLight.local = true;
            dayLight.size.set( 1, 1, 1 ).multiplyScalar( 300 );

            // DOME

            skyMesh.visible = false;

            if ( skyCache[ pars.domeSize ] === undefined ) {

                var d = -50;
                var geo = XG.IBLUtils.createDomeGeometry( pars.domeSize, 32, 16, d );

                var sky = new XG.Mesh( geo, skyMaterial );
                sky.position.y = 35;
                sky.rotation.y = Math.PI;
                sky.receiveShadow = true;
                sky.renderDepth = 10;
                scene.add( sky );

                skyCache[ pars.domeSize ] = sky;

            }

            skyMesh = skyCache[ pars.domeSize ];
            skyMesh.visible = true;

            skyUniforms.map.value = background;
            skyUniforms.intensity.value = 1.25;
            skyUniforms.ambient.value = 0.1;

            // HEAT

            if ( effectHeat ) {

                effectHeat.enabled = !! pars.haze;

            }

            // SNOW

            for ( var i = 0, il = particles.length; i < il; i ++ ) {

                var p = particles[ i ];
                p.visible = !! pars.snow;

            }

            // CREDITS

            elEnvCredits.innerHTML = pars[ "credits" ];

        }

        // ---------------------------------------------------------

        function addParticles( root ) {

            var spriteUrls = [

                "textures/sprites/snowflake1.png",
                "textures/sprites/snowflake2.png",
                "textures/sprites/snowflake4.png",
                "textures/sprites/snowflake5.png"

            ];

            var particleCallback = function ( particle ) {

                var velocity = particle.velocity;
                var acceleration = particle.acceleration;
                var spin = particle.spin;
                var size = particle.size;
                var time = particle.time;

                velocity.x = Math.random() - 0.25;
                velocity.y = -5 - 15.0 * Math.random();
                velocity.z = Math.random() - 0.25;

                acceleration.x = Math.random() * 1.5;
                acceleration.y = 0.0;
                acceleration.z = Math.random() * 1.5;

                spin.start = Math.random();
                spin.speed = 0.5 + 0.5 * Math.random();

                size.start = 1;
                size.end = 1;

                time.start = 1.5 * Math.random();
                time.life = 40.25 + 0.25 * Math.random();

                time.start = 20 * Math.random();
                time.life = 20;

            };

            var sprites = [];
            var nSprites = spriteUrls.length;

            for ( var i = 0; i < nSprites; i ++ ) {

                var sprite = XG.ImageUtils.loadTexture( spriteUrls[ i ] );

                var boxGeo1 = new XG.RandomGeometry( { "shape": "box", "vertices": 2 * 1000 / nSprites, "width": 400, "height": 100, "depth": 200 } );
                XG.GeometryUtils.addParticleAttributes( boxGeo1 );
                XG.GeometryUtils.setParticleAttributes( boxGeo1,  particleCallback );

                var boxGeo2 = new XG.RandomGeometry( { "shape": "box", "vertices": 2 * 350 / nSprites, "width": 200, "height": 100, "depth": 100 } );
                XG.GeometryUtils.addParticleAttributes( boxGeo2 );
                XG.GeometryUtils.setParticleAttributes( boxGeo2,  particleCallback );

                var color = new XG.Color().setHSV( 0, 0, 1 );

                var particleMaterial = new XG.DynamicParticleMaterial(
                        {
                            "map": sprite,
                            "color": color.getHex(),
                            "opacity": 1,
                            "particleSize": 2,
                            "timeRange": 20.0,
                            "transparent": true,
                            "depthWrite": false,
                        } );

                particleMaterial.interpolateFrames = false;

                particleMaterials[ i ] = particleMaterial;

                //

                var ry = Math.PI * 0.15;

                var particles1 = new XG.Particles( boxGeo1, particleMaterial );
                particles1.position.set( 50.0, 200.0, 125.0 );
                particles1.rotation.y = ry;
                root.add( particles1 );

                var particles2 = new XG.Particles( boxGeo1, particleMaterial );
                particles2.position.set( -50.0, 200.0, -125.0 );
                particles2.rotation.y = ry;
                root.add( particles2 );

                var particles3 = new XG.Particles( boxGeo2, particleMaterial );
                particles3.position.set( -150.0, 200.0, 75.0 );
                particles3.rotation.y = ry;
                root.add( particles3 );

                var particles4 = new XG.Particles( boxGeo2, particleMaterial );
                particles4.position.set( 150.0, 200.0, -75.0 );
                particles4.rotation.y = ry;
                root.add( particles4 );

                var particles5 = new XG.Particles( boxGeo2, particleMaterial );
                particles5.position.set( 0.0, 285.0, 0.0 );
                particles5.rotation.y = ry;
                root.add( particles5 );

                particles1.visible = false;
                particles2.visible = false;
                particles3.visible = false;
                particles4.visible = false;
                particles5.visible = false;

                particles.push( particles1 );
                particles.push( particles2 );
                particles.push( particles3 );
                particles.push( particles4 );
                particles.push( particles5 );

            }

        }

        // --------------------------------------------------------------------

        function initMenu() {

            var elMenuButton = document.getElementById( "menubutton" );
            var elMenuEnv = document.getElementById( "environments" );

            var generateHandler = function( i ) {

                return function() {

                    iblIndex = i;
                    setIBL( iblIndex );

                };

            }

            for ( var i = 0, il = iblConfig.length; i < il; i ++ ) {

                var cfg = iblConfig[ i ];

                var buttonEnv = document.createElement( "div" );
                buttonEnv.innerHTML = "<img src='"+ cfg.thumb + "'/>";
                buttonEnv.className = "thumb";

                buttonEnv.addEventListener( "click", generateHandler( i ), true );

                elMenuEnv.appendChild( buttonEnv );

            }

            elMenuButton.addEventListener( "click", function ( event ) {

                if ( menuVisible ) {

                    elMenuEnv.style.display = "none";
                    elMenuButton.innerHTML = "+";

                    menuVisible = false;

                } else {

                    elMenuEnv.style.display = "inline-block";
                    elMenuButton.innerHTML = "-";

                    menuVisible = true;

                }

            }, true );

        }

        // --------------------------------------------------------------------

        function checkStatus() {

            if ( !loaded )  {

                loadCounter += 1;

                if ( loadCounter > 7 ) {

                    loaded = true;
                    loadingElement.style.display = "none";

                }

            }

        }

        // --------------------------------------------------------------------

        function animate() {

            requestAnimationFrame( animate );

            render();
            stats.update();

        }

        // --------------------------------------------------------------------

        function render() {

            var delta = clock.getDelta();
            var time = Date.now();

            if ( heatUniforms ) {

                heatUniforms[ "time" ].value += delta;
                heatUniforms[ 'cameraNearFar' ].value.set( camera.near, camera.far );

            }

            if ( baker ) {

                baker.bake( bakeN );

            }

            // update animations

            for ( var i = 0, il = particleMaterials.length; i < il; i ++ ) {

                particleMaterial = particleMaterials[ i ];
                particleMaterial.time += delta;

            }

            // update camera

            if ( ! cameraFreeze ) {

                targetX = mouseX * .002;
                targetY = mouseY * .002;

                angle  += 0.05 * ( targetX - angle );
                height += 0.05 * ( targetY - height );

                var r = cameraDistance;
                var d = 100;

                var x = -Math.sin( angle ) * r;
                var z =  Math.cos( angle ) * r;
                var y = 100 * height + d;

                camera.position.set( x, y, z );
                camera.lookAt( target );

            }

            renderer.render( scene, camera );

            if ( ! useDeferred ) {

                var overlayCamera = XG.EffectComposer.camera;
                var overlayScene = XG.EffectComposer.scene;
                var overlayMaterials = XG.EffectComposer.quad.materials;
                overlayMaterials[ 0 ] = overlayMaterial;

                renderer.autoClear = false;
                renderer.render( overlayScene, overlayCamera );
                renderer.autoClear = true;

            }

        }

        init();
        animate();

    }

</script>
</body>
</html>
